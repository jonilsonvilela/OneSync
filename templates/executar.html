{% extends 'base.html' %}

{% block content %}
<h1 class="text-2xl font-semibold mb-4">üöÄ Executando Atualiza√ß√£o</h1>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 rounded-lg shadow text-center transition-all hover:shadow-lg hover:scale-105">
        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">TOTAL</h3>
        <p id="total-count" class="text-3xl font-bold text-gray-800 mt-2">0</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center transition-all hover:shadow-lg hover:scale-105">
        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">CONCLU√çDOS</h3>
        <p id="concluidos-count" class="text-3xl font-bold text-green-600 mt-2">0</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center transition-all hover:shadow-lg hover:scale-105">
        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">FALHAS</h3>
        <p id="falhados-count" class="text-3xl font-bold text-red-600 mt-2">0</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center transition-all hover:shadow-lg hover:scale-105">
        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">RESTANTES</h3>
        <p id="restantes-count" class="text-3xl font-bold text-indigo-600 mt-2">0</p>
    </div>
</div>
<div class="flex items-center space-x-4 mb-4">
  <svg id="spinner" class="animate-spin h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
  </svg>
  <span id="status-text" class="text-indigo-700 font-medium">Aguarde... script em execu√ß√£o</span>
</div>

<div class="bg-black text-green-400 p-4 rounded-lg h-[50vh] overflow-auto text-sm font-mono shadow" id="log">
  <p>Iniciando log ao vivo...</p>
</div>

<div id="botoes-finais" class="mt-6 hidden">
  <a href="{{ url_for('index') }}" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800 transition">
    üîô Voltar ao Dashboard
  </a>
  <a href="{{ url_for('resultado') }}" class="ml-4 bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 transition">
    üìÑ Ver √öltimo Resultado
  </a>
</div>

<script>
  const logDiv = document.getElementById('log');
  const botoesFinais = document.getElementById('botoes-finais');
  const spinner = document.getElementById('spinner');
  const statusText = document.getElementById('status-text');
  
  // Elementos do painel de progresso
  const totalEl = document.getElementById('total-count');
  const concluidosEl = document.getElementById('concluidos-count');
  const falhadosEl = document.getElementById('falhados-count');
  const restantesEl = document.getElementById('restantes-count');
  
  const eventSource = new EventSource('/stream');

  eventSource.onmessage = function(event) {
    if (!event.data) return;
    
    const data = JSON.parse(event.data);

    if (data.type === 'log') {
        const novaLinha = document.createElement('div');
        novaLinha.textContent = data.message;
        logDiv.appendChild(novaLinha);
        logDiv.scrollTop = logDiv.scrollHeight;
    } else if (data.type === 'progress') {
        totalEl.textContent = data.total;
        concluidosEl.textContent = data.concluidos;
        falhadosEl.textContent = data.falhados;
        restantesEl.textContent = data.restantes;
    }
  };

  eventSource.onerror = function() {
    eventSource.close();

    const fim = document.createElement('div');
    fim.textContent = '‚úÖ Execu√ß√£o finalizada. Conex√£o com o servidor encerrada.';
    fim.classList.add('text-yellow-400', 'mt-4');
    logDiv.appendChild(fim);

    // Esconde o spinner e atualiza o texto de status
    spinner.classList.add('hidden');
    statusText.textContent = "Execu√ß√£o conclu√≠da!";
    statusText.classList.remove('text-indigo-700');
    statusText.classList.add('text-green-700');

    botoesFinais.classList.remove('hidden');
  };
</script>
{% endblock %}