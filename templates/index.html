{% extends 'base.html' %}

{% block content %}
<h1 class="text-2xl font-semibold mb-6">üìÇ Atualiza√ß√£o de Processos</h1>

<form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data"
      class="bg-white p-6 rounded-lg shadow-md space-y-6"
      x-data="{
        filename: '',
        dragover: false,
        validate(file) {
          if (!file.name.endsWith('.xlsx')) {
            alert('Apenas arquivos .xlsx s√£o aceitos.');
            return false;
          }
          this.filename = file.name;
          return true;
        },
        drop(e) {
          e.preventDefault();
          this.dragover = false;
          const file = e.dataTransfer.files[0];
          if (this.validate(file)) {
            $refs.fileInput.files = e.dataTransfer.files;
          }
        }
      }"
      @dragover.prevent="dragover = true"
      @dragleave.prevent="dragover = false"
      @drop="drop($event)"
>

  <div class="border-2 border-dashed p-6 rounded-lg text-center transition-all duration-200"
       :class="dragover ? 'border-indigo-600 bg-indigo-50' : 'border-gray-300'">
    <p class="text-sm mb-2">Arraste o arquivo .xlsx aqui ou clique abaixo para selecionar</p>
    <input type="file" name="arquivo" accept=".xlsx" required
           class="block mx-auto text-sm"
           x-ref="fileInput"
           @change="filename = $refs.fileInput.files[0]?.name || ''"
    />
    <template x-if="filename">
      <p class="mt-2 text-sm text-green-600">üìé <strong x-text="filename"></strong> selecionado.</p>
    </template>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label for="start_row" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Linha Inicial (Excel):</label>
      <input type="number" name="start_row" id="start_row" min="2" placeholder="Ex: 2"
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
      <p class="text-xs text-gray-500 mt-1">Primeira linha de dados a processar (a linha 2 do Excel √© a primeira linha de dados). Deixe em branco para come√ßar do in√≠cio.</p>
    </div>
    <div>
      <label for="end_row" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Linha Final (Excel):</label>
      <input type="number" name="end_row" id="end_row" min="2" placeholder="Ex: 101"
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
      <p class="text-xs text-gray-500 mt-1">√öltima linha de dados a processar (inclusive). Deixe em branco para ir at√© o final.</p>
    </div>
  </div>
  <div class="flex justify-between items-center">
    <button type="submit"
            class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
      üì§ Enviar Arquivo
    </button>

    <a href="#" id="executar-btn"
       onclick="executarComLote(event)"
       class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
      ‚ñ∂Ô∏è Executar Lote Selecionado
    </a>
  </div>
</form>

<script>
  function executarComLote(event) {
    event.preventDefault(); // Impede a navega√ß√£o padr√£o do link
    const startRow = document.getElementById('start_row').value;
    const endRow = document.getElementById('end_row').value;
    
    // Constr√≥i a URL com os par√¢metros
    let url = "{{ url_for('executar_rpa') }}";
    const params = new URLSearchParams();
    if (startRow) params.append('start', startRow);
    if (endRow) params.append('end', endRow);
    
    if (params.toString()) {
      url += '?' + params.toString();
    }
    
    // Redireciona para a URL de execu√ß√£o com os par√¢metros
    window.location.href = url;
  }
</script>

{% endblock %}